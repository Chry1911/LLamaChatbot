<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>

<body class="bg-gray-100 p-8">

<!-- Demo Page Content -->
<div class="max-w-4xl mx-auto">
  <h1 class="text-4xl font-bold text-gray-900 mb-4">Benvenuto su LLamaChat</h1>
  <p class="text-gray-600 mb-8">Clicca sull'icona in basso a destra per iniziare a chattare con l'AI! ğŸ¦™</p>
  
  <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
    <h2 class="text-2xl font-semibold text-gray-900 mb-4">FunzionalitÃ </h2>
    <ul class="space-y-2 text-gray-700">
      <li>âœ… Chat con AI in tempo reale</li>
      <li>ğŸ“„ Carica e analizza PDF</li>
      <li>ğŸ“§ Leggi e riassumi email</li>
      <li>ğŸ¨ Temi personalizzabili</li>
      <li>ğŸ’¬ Conversazioni multiple</li>
    </ul>
  </div>
</div>

<!-- CHATBOT WIDGET -->
<div 
  x-data="chatWidget()"
  x-init="init()"
  x-cloak
>
  
  <!-- Floating Button -->
  <button 
    x-show="!open"
    @click="open = true"
    class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full shadow-2xl flex items-center justify-center text-white text-2xl hover:scale-110 transition-transform z-50"
  >
    ğŸ’¬
  </button>

  <!-- Chat Window -->
  <div 
    x-show="open"
    x-transition
    class="fixed bottom-6 right-6 w-[380px] rounded-2xl shadow-2xl bg-white overflow-hidden z-50"
  >

    <!-- HEADER -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center font-semibold">
          AI
        </div>
        <div>
          <div class="font-semibold">LLamaChat</div>
          <div class="text-xs text-green-300 flex items-center gap-1">
            <span class="w-2 h-2 bg-green-300 rounded-full"></span>
            Online
          </div>
        </div>
      </div>
      
      <!-- User Avatar with Menu -->
      <div class="relative" x-data="{ menuOpen: false }">
        <button @click.stop="menuOpen = !menuOpen" class="w-9 h-9 bg-white/20 rounded-full flex items-center justify-center font-semibold hover:bg-white/30 transition-colors">
          <span x-text="user.initials"></span>
        </button>

        <!-- User Dropdown -->
        <div x-show="menuOpen" @click.away="menuOpen = false" x-cloak
          class="absolute right-0 top-12 w-56 bg-white rounded-xl shadow-2xl z-50 overflow-hidden">
          <div class="p-3 bg-gray-50 border-b">
            <div class="font-semibold text-gray-900 text-sm" x-text="user.name"></div>
            <div class="text-xs text-gray-500" x-text="user.email"></div>
          </div>
          <div class="p-1">
            <button @click="menuOpen = false" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg text-sm flex items-center gap-2">
              <span>ğŸ‘¤</span> Profilo
            </button>
            <button @click="showThemeMenu = !showThemeMenu; menuOpen = false" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg text-sm flex items-center gap-2">
              <span>ğŸ¨</span> Temi
            </button>
          </div>
          <div class="border-t p-1">
            <button class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded-lg text-sm flex items-center gap-2">
              <span>ğŸšª</span> Esci
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- TOOLBAR -->
    <div class="bg-gray-50 border-b px-4 py-2 flex gap-2 items-center">
      <button @click="openConversations()" class="flex-1 px-3 py-1.5 bg-white hover:bg-gray-100 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
        ğŸ’¬ Chat
      </button>
      <button @click="openPdfModal()" class="px-3 py-1.5 bg-white hover:bg-gray-100 rounded-lg text-sm transition-colors" title="Carica PDF">
        ğŸ“„
      </button>
      <button @click="openEmailModal()" class="px-3 py-1.5 bg-white hover:bg-gray-100 rounded-lg text-sm transition-colors" title="Leggi Email">
        ğŸ“§
      </button>
      <button @click="showThemeMenu = !showThemeMenu" class="px-3 py-1.5 bg-white hover:bg-gray-100 rounded-lg text-sm transition-colors" title="Temi">
        ğŸ¨
      </button>
      <button @click="open = false" class="px-3 py-1.5 bg-white hover:bg-gray-100 rounded-lg text-sm transition-colors">
        âœ•
      </button>
    </div>

    <!-- Theme Selector -->
    <div x-show="showThemeMenu" x-cloak class="bg-blue-50 border-b px-4 py-2">
      <div class="text-xs font-semibold text-gray-600 mb-2">Seleziona Tema</div>
      <div class="flex gap-2">
        <button @click="theme='dark'; showThemeMenu=false" :class="theme==='dark' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'" class="flex-1 px-2 py-1 rounded text-xs font-medium">Dark</button>
        <button @click="theme='light'; showThemeMenu=false" :class="theme==='light' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'" class="flex-1 px-2 py-1 rounded text-xs font-medium">Light</button>
        <button @click="theme='blue'; showThemeMenu=false" :class="theme==='blue' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'" class="flex-1 px-2 py-1 rounded text-xs font-medium">Blue</button>
      </div>
    </div>

    <!-- CONVERSATIONS LIST -->
    <div x-show="view === 'conversations'" x-cloak class="h-[420px] overflow-y-auto p-3 space-y-2 bg-gray-50">
      <button @click="newConversation()" class="w-full py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
        â• Nuova Conversazione
      </button>
      
      <template x-for="conv in conversations" :key="conv.id">
        <div @click="loadConversation(conv.id)" class="p-3 bg-white hover:bg-gray-100 rounded-lg cursor-pointer transition-colors border border-gray-200">
          <div class="font-medium text-sm text-gray-900" x-text="conv.title"></div>
        </div>
      </template>
    </div>

    <!-- MESSAGES -->
    <div 
      x-show="view === 'chat'"
      x-ref="chatArea"
      class="h-[420px] overflow-y-auto p-4 space-y-3"
      :class="theme === 'light' ? 'bg-gray-50' : theme === 'blue' ? 'bg-gradient-to-b from-blue-900 to-blue-800' : 'bg-gradient-to-b from-gray-900 to-gray-800'"
    >
      <template x-for="(msg, idx) in messages" :key="idx">
        <div class="flex gap-2" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
          
          <!-- Bot Avatar -->
          <div x-show="msg.role !== 'user'" class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs flex-shrink-0">
            AI
          </div>

          <!-- Message Bubble -->
          <div 
            class="rounded-2xl px-4 py-2 max-w-[75%] text-sm"
            :class="msg.role === 'user' ? 'bg-blue-600 text-white' : theme === 'light' ? 'bg-white text-gray-900 border border-gray-200' : 'bg-white/10 text-white'"
            x-html="marked.parse(msg.text)"
          ></div>

          <!-- User Avatar -->
          <div x-show="msg.role === 'user'" class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-xs font-semibold flex-shrink-0" x-text="user.initials">
          </div>
        </div>
      </template>

      <!-- Typing -->
      <div x-show="isTyping" x-cloak class="flex gap-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs">
          AI
        </div>
        <div class="bg-white/10 rounded-2xl px-4 py-2">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- INPUT -->
    <div class="border-t p-3 flex gap-2 bg-white">
      <input 
        x-model="inputMessage"
        @keydown.enter="sendMessage()"
        class="flex-1 border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Scrivi un messaggio..."
      />
      <button 
        @click="sendMessage()"
        :disabled="!inputMessage.trim()"
        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white px-4 rounded-xl transition-colors"
      >
        â¤
      </button>
    </div>

  </div>

  <!-- PDF MODAL -->
  <div x-show="pdfModalOpen" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
    <div @click.away="pdfModalOpen = false" class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold">ğŸ“„ Carica PDF</h3>
        <button @click="pdfModalOpen = false" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>

      <div class="p-4">
        <div 
          @click="$refs.pdfInput.click()"
          @dragover.prevent
          @drop.prevent="handlePdfDrop($event)"
          :class="selectedPdf ? 'border-green-400 bg-green-50' : 'border-gray-300'"
          class="border-2 border-dashed rounded-xl p-6 text-center cursor-pointer"
        >
          <input type="file" x-ref="pdfInput" @change="handlePdfSelect($event)" accept=".pdf" class="hidden"/>
          
          <div x-show="!selectedPdf">
            <div class="text-4xl mb-2">ğŸ“</div>
            <div class="text-sm text-gray-600">Clicca o trascina un PDF</div>
            <div class="text-xs text-gray-400 mt-1">Max 10MB</div>
          </div>

          <div x-show="selectedPdf" x-cloak class="flex items-center justify-center gap-2">
            <div class="text-2xl">âœ…</div>
            <div class="text-sm font-medium" x-text="selectedPdf?.name"></div>
          </div>
        </div>

        <button 
          @click="uploadPdf()"
          :disabled="!selectedPdf || pdfUploading"
          class="w-full mt-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-lg font-medium text-sm"
        >
          <span x-show="!pdfUploading">Genera Riassunto</span>
          <span x-show="pdfUploading" x-cloak>Elaborazione...</span>
        </button>

        <div x-show="pdfSummary" x-cloak class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
          <div class="font-semibold text-sm mb-1">ğŸ“ Riassunto:</div>
          <div class="text-xs text-gray-700" x-text="pdfSummary"></div>
          <button @click="addPdfToChat()" class="w-full mt-2 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
            Aggiungi alla Chat
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- EMAIL MODAL -->
  <div x-show="emailModalOpen" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
    <div @click.away="emailModalOpen = false" class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold">ğŸ“§ Leggi Email</h3>
        <button @click="closeEmailModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>

      <div class="p-4">
        <!-- Login -->
        <div x-show="emailStep === 'login'" class="space-y-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Provider</label>
            <select x-model="emailProvider" class="w-full px-3 py-2 border rounded-lg text-sm">
              <option value="gmail">Gmail</option>
              <option value="outlook">Outlook</option>
              <option value="yahoo">Yahoo</option>
              <option value="icloud">iCloud</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
            <input x-model="emailAddress" type="email" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="tuo@email.com"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Password</label>
            <input x-model="emailPassword" type="password" class="w-full px-3 py-2 border rounded-lg text-sm"/>
            <div class="text-xs text-gray-500 mt-1">
              âš ï¸ Gmail: usa <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-blue-600">App Password</a>
            </div>
          </div>
          <button @click="connectEmail()" :disabled="emailConnecting" class="w-full py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-lg text-sm font-medium">
            <span x-show="!emailConnecting">Connetti</span>
            <span x-show="emailConnecting" x-cloak>Connessione...</span>
          </button>
        </div>

        <!-- Email List -->
        <div x-show="emailStep === 'list'" x-cloak>
          <div class="mb-3 p-2 bg-green-50 rounded-lg flex justify-between items-center">
            <span class="text-xs font-medium" x-text="emailAddress"></span>
            <button @click="disconnectEmail()" class="text-xs text-gray-600">Disconnetti</button>
          </div>

          <div class="space-y-2 max-h-80 overflow-y-auto">
            <template x-for="email in emailList" :key="email.id">
              <div @click="readEmail(email.id)" class="p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <div class="font-medium text-xs text-gray-900" x-text="email.subject"></div>
                <div class="text-xs text-gray-500 mt-1" x-text="email.from"></div>
              </div>
            </template>
          </div>
        </div>

        <!-- Email Detail -->
        <div x-show="emailStep === 'detail'" x-cloak>
          <button @click="emailStep = 'list'" class="mb-3 text-blue-600 text-sm">â† Indietro</button>

          <div x-show="currentEmail" class="space-y-3">
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="font-bold text-sm mb-2" x-text="currentEmail?.subject"></div>
              <div class="text-xs text-gray-600">
                <div><strong>Da:</strong> <span x-text="currentEmail?.from"></span></div>
                <div><strong>Data:</strong> <span x-text="currentEmail?.date"></span></div>
              </div>
            </div>

            <div class="p-3 bg-white border rounded-lg max-h-40 overflow-y-auto">
              <pre class="whitespace-pre-wrap text-xs" x-text="currentEmail?.body"></pre>
            </div>

            <button @click="addEmailToChat()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
              Aggiungi alla Chat
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
function chatWidget() {
  return {
    open: false,
    view: 'chat', // 'conversations' or 'chat'
    theme: 'dark',
    showThemeMenu: false,

    user: {
      name: 'Utente',
      email: 'utente@example.com',
      initials: 'U'
    },

    conversations: [],
    currentConv: null,
    messages: [],
    inputMessage: '',
    isTyping: false,

    pdfModalOpen: false,
    selectedPdf: null,
    pdfUploading: false,
    pdfSummary: '',

    emailModalOpen: false,
    emailStep: 'login',
    emailProvider: 'gmail',
    emailAddress: '',
    emailPassword: '',
    emailConnecting: false,
    emailList: [],
    currentEmail: null,

    async init() {
      await this.loadConversations();
    },

    async loadConversations() {
      try {
        const res = await fetch('/conversations');
        this.conversations = await res.json();
      } catch (err) {
        console.error(err);
      }
    },

    openConversations() {
      this.view = 'conversations';
    },

    async newConversation() {
      try {
        const res = await fetch('/conversation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: 'Nuova chat' })
        });
        const data = await res.json();
        await this.loadConversations();
        await this.loadConversation(data.id);
      } catch (err) {
        console.error(err);
      }
    },

    async loadConversation(id) {
      try {
        const res = await fetch(`/conversation/${id}`);
        const conv = await res.json();
        this.currentConv = id;
        this.messages = conv.messages;
        this.view = 'chat';
        this.$nextTick(() => {
          this.$refs.chatArea.scrollTop = this.$refs.chatArea.scrollHeight;
        });
      } catch (err) {
        console.error(err);
      }
    },

    async sendMessage() {
      if (!this.inputMessage.trim()) return;

      if (!this.currentConv) {
        await this.newConversation();
        await new Promise(r => setTimeout(r, 300));
      }

      const message = this.inputMessage;
      this.inputMessage = '';

      this.messages.push({ role: 'user', text: message });
      this.$nextTick(() => {
        this.$refs.chatArea.scrollTop = this.$refs.chatArea.scrollHeight;
      });

      try {
        await fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conv_id: this.currentConv, message })
        });

        this.isTyping = true;
        const streamRes = await fetch('/start_stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conv_id: this.currentConv })
        });

        const streamData = await streamRes.json();
        let botMessage = { role: 'assistant', text: '' };
        this.messages.push(botMessage);

        const eventSource = new EventSource(`/events/${streamData.conv_id}`);
        
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          
          if (data.type === 'token') {
            botMessage.text += data.text;
            this.$nextTick(() => {
              this.$refs.chatArea.scrollTop = this.$refs.chatArea.scrollHeight;
            });
          } else if (data.type === 'done') {
            this.isTyping = false;
            eventSource.close();
          } else if (data.type === 'error') {
            this.isTyping = false;
            botMessage.text = 'Errore';
            eventSource.close();
          }
        };

        eventSource.onerror = () => {
          this.isTyping = false;
          eventSource.close();
        };

      } catch (err) {
        console.error(err);
        this.isTyping = false;
      }
    },

    openPdfModal() {
      this.pdfModalOpen = true;
      this.selectedPdf = null;
      this.pdfSummary = '';
    },

    handlePdfSelect(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/pdf') {
        this.selectedPdf = file;
      }
    },

    handlePdfDrop(event) {
      const file = event.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        this.selectedPdf = file;
      }
    },

    async uploadPdf() {
      if (!this.selectedPdf) return;

      this.pdfUploading = true;
      const formData = new FormData();
      formData.append('file', this.selectedPdf);

      try {
        const res = await fetch('/api/pdf/summary', {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        
        console.log('PDF Response:', data); // Debug
        
        if (data.success && data.summary) {
          this.pdfSummary = data.summary;
        } else if (data.error) {
          alert('Errore: ' + data.error);
        } else {
          alert('Nessun riassunto ricevuto');
        }
      } catch (err) {
        console.error('Errore upload PDF:', err);
        alert('Errore: ' + err.message);
      } finally {
        this.pdfUploading = false;
      }
    },

    async addPdfToChat() {
      if (!this.pdfSummary) {
        alert('Nessun riassunto da aggiungere');
        return;
      }
      
      this.pdfModalOpen = false;
      
      // Se non c'Ã¨ conversazione corrente, creane una
      if (!this.currentConv) {
        await this.newConversation();
        await new Promise(r => setTimeout(r, 500));
      }
      
      this.view = 'chat';
      this.inputMessage = `ğŸ“„ **Riassunto PDF (${this.selectedPdf?.name}):**\n\n${this.pdfSummary}`;
      
      // Aspetta un attimo che la vista sia cambiata
      await this.$nextTick();
      await this.sendMessage();
    },

    openEmailModal() {
      this.emailModalOpen = true;
      this.emailStep = 'login';
    },

    closeEmailModal() {
      this.emailModalOpen = false;
      this.emailAddress = '';
      this.emailPassword = '';
    },

    async connectEmail() {
      if (!this.emailAddress || !this.emailPassword) return;

      this.emailConnecting = true;

      try {
        const res = await fetch('/api/email/list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: this.emailAddress,
            password: this.emailPassword,
            provider: this.emailProvider,
            limit: 20
          })
        });

        const data = await res.json();

        if (data.success) {
          this.emailList = data.emails;
          this.emailStep = 'list';
        } else {
          alert('Errore: ' + data.error);
        }
      } catch (err) {
        alert('Errore: ' + err.message);
      } finally {
        this.emailConnecting = false;
      }
    },

    disconnectEmail() {
      this.emailStep = 'login';
      this.emailPassword = '';
    },

    async readEmail(emailId) {
      try {
        const res = await fetch('/api/email/read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: this.emailAddress,
            password: this.emailPassword,
            provider: this.emailProvider,
            email_id: emailId
          })
        });

        const data = await res.json();

        if (data.success) {
          this.currentEmail = data.email;
          this.emailStep = 'detail';
        } else {
          alert('Errore: ' + data.error);
        }
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    },

    async addEmailToChat() {
      this.emailModalOpen = false;
      this.view = 'chat';
      
      const emailText = `ğŸ“§ **Email**\n\n**Oggetto:** ${this.currentEmail.subject}\n**Da:** ${this.currentEmail.from}\n\n${this.currentEmail.body.substring(0, 1000)}`;

      this.inputMessage = emailText;
      await this.sendMessage();
    }
  }
}
</script>

</body>
</html>